<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>挖机问题总单</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
  :root{--card-shadow: 0 8px 30px rgba(16,24,40,0.08);}body{font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
  .card-hover{transition:transform .18s ease, box-shadow .18s ease}.card-hover:hover{transform:translateY(-6px); box-shadow:var(--card-shadow)}
  .badge-ui{background:linear-gradient(90deg,#60a5fa,#7c3aed); color:white}
  .badge-backend{background:linear-gradient(90deg,#34d399,#06b6d4); color:white}
  .badge-perf{background:linear-gradient(90deg,#f97316,#f43f5e); color:white}
  .badge-security{background:linear-gradient(90deg,#ef4444,#c026d3); color:white}
  .badge-compat{background:linear-gradient(90deg,#f59e0b,#84cc16); color:white}
  .fade-in{animation:fadeIn .28s ease both}@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-indigo-50 min-h-screen font-sans">
      <div id="data-container" class="my-8 text-center text-gray-700">正在加载数据……</div>
    <!-- 登录弹窗遮罩和内容 -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" style="backdrop-filter: blur(2px);">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-xs flex flex-col items-center animate-fadeIn" style="animation:fadeIn .4s both;">
        <div class="mb-6 flex flex-col items-center">
          <svg width="48" height="48" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#6366f1"/><path d="M12 13a4 4 0 100-8 4 4 0 000 8zm0 2c-3.31 0-6 1.34-6 3v1a1 1 0 001 1h10a1 1 0 001-1v-1c0-1.66-2.69-3-6-3z" fill="#fff"/></svg>
          <h2 class="text-xl font-bold text-indigo-700 mt-2">登录验证</h2>
          <p class="text-gray-500 text-sm mt-1">请输入用户名和密码</p>
        </div>
        <form id="login-form" class="w-full flex flex-col gap-4">
          <input id="login-username" type="text" placeholder="用户名" autocomplete="username" class="px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-300 outline-none" required />
          <input id="login-password" type="password" placeholder="密码" autocomplete="current-password" class="px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-300 outline-none" required />
          <button type="submit" class="w-full py-2 mt-2 rounded-lg bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700 transition">登录</button>
          <div id="login-error" class="text-red-500 text-xs text-center mt-2 hidden">用户名或密码错误</div>
        </form>
      </div>
    </div>
  <header class="max-w-6xl mx-auto py-10 px-4">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-700">挖机问题总单</h1>
        <p class="text-gray-600 mt-1">记录 ID、现象 和 Bug 分类，支持按分类筛选与搜索</p>
      </div>
      <div class="hidden md:block">
        <img src="https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=400&auto=format&fit=crop&ixlib=rb-4.0.3&s=3f8f6b4b0f1d5a7c8c8e4b7a9d6c4b3a" alt="decor" class="w-36 h-24 object-cover rounded-lg shadow-lg">
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-12">
    <section class="bg-white/80 backdrop-blur-sm shadow-xl rounded-2xl p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex flex-col gap-2 w-full md:w-2/3">
          <div class="flex items-center gap-3">
            <input id="search" type="search" placeholder="搜索 ID 或 现象..." class="flex-1 px-4 py-3 rounded-lg border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300" />
            <select id="filter" class="px-4 py-3 rounded-lg border border-gray-200 shadow-sm focus:outline-none">
              <option value="" disabled selected>全部层面</option>
            </select>
            <select id="tag-filter" class="px-4 py-3 rounded-lg border border-gray-200 shadow-sm focus:outline-none">
              <option value="" disabled selected>Tag</option>
            </select>
            <button id="open-add" class="px-4 py-2 bg-green-600 text-white rounded-lg hidden md:inline-block">添加 Bug</button>
          </div>
          <!-- 当前选中的层面 / Tag，以小标签形式展示，可点击叉号删除 -->
          <div class="flex flex-wrap gap-2 text-xs text-gray-500">
            <div id="active-cats" class="flex flex-wrap gap-2"></div>
            <div id="active-tags" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="counts" class="text-sm text-gray-600"></div>
          <button id="reset" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700">重置筛选</button>
        </div>
      </div>

      <!-- small-screen add button: show under controls on small screens -->
      <div class="mt-4 md:hidden">
        <button id="open-add-sm" class="px-4 py-2 bg-green-600 text-white rounded-lg">添加 Bug</button>
      </div>

      <div id="list" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="empty" class="mt-8 hidden text-center text-gray-500">未找到符合条件的 bug。</div>
      <!-- 饼状图容器，放在bug列表卡片下方 -->
      <div id="pie-chart-container" class="mt-10 flex flex-col items-center">
        <div class="w-full flex items-center justify-center my-8">
          <div class="w-full max-w-2xl border-t-2 border-dashed border-indigo-200"></div>
        </div>
        <h2 class="text-lg font-semibold text-gray-700 mb-4">各层面 Bug 占比</h2>
        <div style="max-width:800px;max-height:800px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
          <canvas id="pie-chart" width="660" height="660" style="max-width:660px;max-height:660px;"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-8 text-center text-gray-500 text-sm">
    2025 挖机问题总单
  </footer>

  <!-- 详情模态：放在 body 层级，确保悬浮在所有内容之上 -->
  <div id="detail-modal" class="fixed inset-0 bg-black/40 hidden items-start justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 mx-4 mt-12 mb-12">
      <div class="flex items-center justify-between">
        <h3 id="detail-title" class="text-xl font-semibold">Bug 详情</h3>
        <button id="detail-close" class="text-gray-500 hover:text-gray-700">关闭 ×</button>
      </div>
      <div class="mt-4">
        <div class="text-sm text-gray-500">ID</div>
        <div id="detail-id" class="text-lg font-medium mt-1"></div>
        <div class="text-sm text-gray-500 mt-4">分类</div>
        <select id="detail-category" class="mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm">
          <option value="">未分类</option>
        </select>
            <div class="text-sm text-gray-500 mt-4">Tag</div>
            <div class="mt-1 flex flex-wrap items-center gap-2">
              <input id="detail-tag-input" class="flex-1 min-w-[120px] p-2 border border-gray-200 rounded-lg text-sm" placeholder="输入 tag 后点 + 号" />
              <button id="detail-tag-add" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">+</button>
            </div>
            <div id="detail-tag-list" class="mt-2 flex flex-wrap gap-2"></div>
        <div class="text-sm text-gray-500 mt-4">现象</div>
        <textarea id="detail-symptom" class="w-full mt-2 p-3 border border-gray-200 rounded-lg" rows="4"></textarea>
        <div class="text-sm text-gray-500 mt-4">解决方案</div>
        <textarea id="detail-solution" class="w-full mt-2 p-3 border border-gray-200 rounded-lg" rows="6" placeholder="描述已采取或建议的解决步骤"></textarea>
        <div class="text-sm text-gray-500 mt-4">链接</div>
        <input id="detail-link" class="w-full mt-2 p-3 border border-gray-200 rounded-lg" />
      </div>
      <div class="mt-4 flex justify-between items-center">
        <div>
          <button id="detail-delete" class="px-4 py-2 bg-red-600 text-white rounded">删除</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="detail-cancel" class="px-4 py-2 bg-gray-100 rounded">取消</button>
          <button id="detail-save" class="px-4 py-2 bg-indigo-600 text-white rounded">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加模态：同样放在 body 层级 -->
  <div id="add-modal" class="fixed inset-0 bg-black/40 hidden items-start justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 mx-4 mt-12 mb-12">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">添加 Bug</h3>
        <button id="add-cancel" class="text-gray-500 hover:text-gray-700">关闭 ×</button>
      </div>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="text-sm text-gray-500">ID</div>
          <input id="add-id" class="w-full mt-1 p-2 border border-gray-200 rounded" />
        </div>
        <div>
          <div class="text-sm text-gray-500">现象</div>
          <input id="add-symptom" class="w-full mt-1 p-2 border border-gray-200 rounded" />
        </div>
        <div class="md:col-span-2">
          <div class="text-sm text-gray-500">解决方案</div>
          <textarea id="add-solution" rows="3" class="w-full mt-1 p-2 border border-gray-200 rounded"></textarea>
        </div>
        <div class="md:col-span-2">
          <div class="text-sm text-gray-500">链接</div>
          <input id="add-link" class="w-full mt-1 p-2 border border-gray-200 rounded" />
        </div>
        <div class="md:col-span-2">
          <div class="text-sm text-gray-500">Tag</div>
          <div class="mt-1 flex flex-wrap items-center gap-2">
            <input id="add-tag-input" class="flex-1 min-w-[120px] p-2 border border-gray-200 rounded text-sm" placeholder="输入 tag 后点 + 号" />
            <button id="add-tag-add" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">+</button>
          </div>
          <div id="add-tag-list" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
        <div class="flex items-center gap-2">
          <select id="add-category" class="px-3 py-2 rounded-lg border border-gray-200">
            <option value="">未分类</option>
          </select>
          <input id="add-custom-category" placeholder="自定义分类" class="px-3 py-2 rounded-lg border border-gray-200 hidden" />
        </div>
        <div class="flex items-center justify-end gap-2">
          <button id="add-save" class="px-4 py-2 bg-green-600 text-white rounded-lg">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script>
      // 登录弹窗逻辑
      window.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('login-modal');
        const form = document.getElementById('login-form');
        const user = document.getElementById('login-username');
        const pass = document.getElementById('login-password');
        const err = document.getElementById('login-error');
        function unlock() {
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if(user.value === 'fuxi' && pass.value === '123456') {
            unlock();
          } else {
            err.classList.remove('hidden');
            setTimeout(()=>{err.classList.add('hidden');}, 2000);
            pass.value = '';
            pass.focus();
          }
        });
        // 禁止滚动
        document.body.style.overflow = 'hidden';
        user.focus();
      });
    // 引入 Chart.js
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    document.head.appendChild(chartScript);

    let pieChartInstance = null;

    function renderPieChart(list) {
      if (!window.Chart) return chartScript.onload = () => renderPieChart(list);
      const pieCanvas = document.getElementById('pie-chart');
      if (!pieCanvas) return;
      const ctx = pieCanvas.getContext('2d');
      // 统计各层面数量
      const catCount = {};
      list.forEach(item => {
        const cat = item.category || '未分类';
        catCount[cat] = (catCount[cat] || 0) + 1;
      });
      const labels = Object.keys(catCount);
      const data = Object.values(catCount);
      // 精致配色
      const colors = [
        '#6366f1','#34d399','#f59e42','#f43f5e','#06b6d4','#a78bfa','#fbbf24','#60a5fa','#c026d3','#84cc16','#f87171','#818cf8','#f472b6','#4ade80','#facc15','#eab308','#f97316','#0ea5e9','#e11d48','#64748b'
      ];
      // 销毁旧图
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff',
          }]
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: '#374151',
                font: { size: 15, weight: 'bold' },
                padding: 18
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = data.reduce((a,b)=>a+b,0);
                  const val = context.parsed;
                  const percent = total ? (val/total*100).toFixed(1) : 0;
                  return `${context.label}: ${val} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }
  // 初始数据（已移除示例条目，使用后端/本地缓存数据）
  let data = [];

  const STORAGE_KEY = 'bug-dashboard-bugs';
  // 直接写死数据到前端变量，适用于GitHub Pages静态展示
  const bugData = [
    {
      "id": "#264720",
      "symptom": "卡车轮廓线与实际卡车位置不匹配",
      "category": "感知层",
      "solution": "这个跟卡车检测模型没有关系，应该是视频延迟导致不同步导致",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=264720",
      "tags": [
        "【v2.6】",
        "【自动装车】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#287083",
      "symptom": "装车过满，最后一铲撒料严重",
      "category": "逻辑",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287083",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】",
        "【偶现40%】"
      ]
    },
    {
      "id": "#285922",
      "symptom": "卡车装的太满，没报装满，继续无效装车，撒料",
      "category": "逻辑",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285922",
      "tags": [
        "【2.6.1真机环境】",
        "【双车道】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#278256",
      "symptom": "挖料完成后，转向卡车时，铲斗距离驾驶室过近铲斗内石块有跌落砸到挖机风险",
      "category": "逻辑",
      "solution": "查看挖机和高程图发现出现时间正好卡在两个bag包中间，没有录到完整数据。最后结束时刻可能是如下状态，感觉没有离驾驶室很近。需要检测铲斗内大块物料",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=278256",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#281500",
      "symptom": "端侧服务启动后，无环视相机，上报环视相机故障",
      "category": "硬件",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=281500",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#274254",
      "symptom": "镜像启动后，偶现环视相机故障，频率为0",
      "category": "硬件",
      "solution": "需要硬件同事排查下解串器的状态",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=274254",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#283592",
      "symptom": "第11铲转向挖掘区行人急停误检，关闭行人急停后继续任务，挖机在急停位置下挖，没有转到挖掘点",
      "category": "逻辑",
      "solution": "观察WARN和ERROR日志发现行人检测会在一秒内高频触发和恢复，这会影响子流程的正常运行。行人检测本不应该高频触发恢复，因为真实行人的行为本身具有连续性。建议行人检测触发后不要马上恢复，给一定时间的缓冲。\n装车技能里，手动触发暂停继续，这个地方，要加个禁用5s的cd",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283592",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#279537",
      "symptom": "挖料完成转向卡车时，转过头",
      "category": "规划层",
      "solution": "徐工镜像专门给徐工验收用，版本跟216版本不同，关联https://fuxi.pm.netease.com/v6/issues/279260",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=279537",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】",
        "【徐工镜像】",
        "【偶现10%】"
      ]
    },
    {
      "id": "#278680",
      "symptom": "第8铲在卡车上左右晃（往右转过了一点回调时又转过了）",
      "category": "硬件",
      "solution": "对比/joint_states/swing/velocity和/force_controller/internal_joint_velocity_command/data[3],观察/joint_states/swing/position,观察/pwm/pwm[3]，发现有速度和位置突变情况，或者由于plc解析错误导致下发实际pwm波异常导致，导致突然加速，rviz里面有明显不合理速度变化",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=278680",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】",
        "【偶现5%】"
      ]
    },
    {
      "id": "#287036",
      "symptom": "师傅理料过程中，挖机本体正常，倾覆角度突然异常，定位系统故障",
      "category": "感知层",
      "solution": "融感供应商是车辆约束问题，导致了锁定异常，目前已经放开了定向的参数，认为后续不会出现这样的问题。状态上报这个已经反馈给融感供应商，他们抓包后排查。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287036",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#283326",
      "symptom": "第15铲挖机挖料抬起铲斗后，卡住不动",
      "category": "逻辑",
      "solution": "观察WARN发现子流程被外部暂停，时间戳问题导致的，后面会加锁解决",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283326",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现5%】"
      ]
    },
    {
      "id": "#274108",
      "symptom": "偶现环视和主视角故障，触发急停，重启镜像客户端离线",
      "category": "硬件",
      "solution": "需要硬件同事排查下解串器的状态",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=274108",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#277994",
      "symptom": "第八铲卸料后转向挖掘点，未到挖掘点大小臂下降，铲斗触地旋转",
      "category": "硬件",
      "solution": "对比/joint_states/swing/velocity和/force_controller/internal_joint_velocity_command/data[3]发现沃尔沃座舱发加速命令，但减速。之前和天业已经沟通过，天业会更新一版固件尝试解决",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=277994",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#287229",
      "symptom": "挖料不收斗，抬大臂撒料，挖料异常，阻塞装车，初步定位铲斗pwm下发-1000不动作",
      "category": "硬件",
      "solution": "天业已经更新程序",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287229",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#286226",
      "symptom": "reboot重启jetson后，其中一块can板无信号",
      "category": "硬件",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286226",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#283682",
      "symptom": "挖料时铲斗猛砸地面",
      "category": "控制层",
      "solution": "对比/joint_states/boom/velocity和/force_controller/internal_joint_velocity_command/data[0]发现命令速度发的时候没有跟上，跟档位有关，调节档位到7档。目前版本无法准确控制大臂速度和位置关系，待新版轨迹功能研发。大臂考虑拆节流阀，再重新训练速度控制器，提高稳定性。看是否可以调节节流阀的流量，宣辰可以和玉伯确认下，需要再训练下大臂前馈。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283682",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#281618",
      "symptom": "启动镜像后无法控制档位，需要在端侧jetson手动开启油门档位控制开关",
      "category": "硬件",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=281618",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#273608",
      "symptom": "挖机旋转，右上角模型不会旋转",
      "category": "硬件",
      "solution": "编码器数据丢失导致的，目前can报文是恢复的状态，怀疑是天业的下位机bug或者编码器没上电导致。已经联系天业指导修复，后续志强在跟进。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=273608",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#282002",
      "symptom": "第21铲前面装满一直在往前部卸料，导致物料撒出",
      "category": "逻辑",
      "solution": "观察高程图发现：\n由于靠近车头部分的高程图是未填满状态且无法更新，导致高程图表现出断崖式的变化，在21铲装车时由于高程图或者坐标转换误差等的微小变化刚好导致在“断崖”交界处的某点处于IK求解范围内，就导致卸料点往前推荐了。\n要解决该问题，\n1.要么解决高程图在车头附近无法更新的问题\n2.要么卸料能够严格从车头开始到车尾，这个得有下大臂和推料手法。\n3.要么修改卸料点逻辑，严格按照从前往后推荐，但该逻辑不合理。\n当前版本无法解决，且该问题出现概率极低（首次遇到），改为后续版本修复。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=282002",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现:5%】"
      ]
    },
    {
      "id": "#285480",
      "symptom": "第12、15铲挖料完成后转向卡车时缓慢动作，影响效率",
      "category": "控制层",
      "solution": "对比/joint_states/boom/velocity和/force_controller/internal_joint_velocity_command/data[0],观察/joint_states/boom/position,观察/pwm/pwm[0]发现大臂已经发了最大的pwm，可能已经到达极限位置或者负载太大导致，已经无法继续抬升。导致无法退出碰撞处理状态",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285480",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现10%】"
      ]
    },
    {
      "id": "#283324",
      "symptom": "挖机挖料时，偶尔会停顿一下，影响装车效率",
      "category": "控制层",
      "solution": "更新挖料手法后解决",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283324",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现20%】"
      ]
    },
    {
      "id": "#265965",
      "symptom": "装车过程中暂停再继续，同时段装车的kpl文件被分为两个文件",
      "category": "逻辑",
      "solution": "目前暂不支持暂停接续",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=265965",
      "tags": [
        "【v2.6】",
        "【自动装车】",
        "【真机环境】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#287010",
      "symptom": "挖机卸料时偏左且撒料，前面没装满，一直装后面",
      "category": "规划层",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287010",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】",
        "【偶现10%】"
      ]
    },
    {
      "id": "#286531",
      "symptom": "挖料完成转向卡车时，转过卸料点，慢慢回调，影响装车效率",
      "category": "规划层",
      "solution": "观察轨迹图发现轨迹超调过头",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286531",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#284074",
      "symptom": "挖料时重复调用挖掘点",
      "category": "规划层",
      "solution": "卸料点模块推荐完卸料点后，为了保证安全之前强行拉高了卸料点高度，这个高度在卡车本身很高的情况下有可能超出IK求解范围，导致load模块崩溃后一直重新调用子流程。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=284074",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现：2%】",
        "【卸料点异常】"
      ]
    },
    {
      "id": "#284144",
      "symptom": "挖料收斗时，卡顿5秒左右再继续作业",
      "category": "逻辑",
      "solution": "挖斗给了指令但是比较小，被挖料卡住后无法运动。\n对运动速度过慢的处理逻辑是抬大臂，但是有次数限制，视频中达到了了上抬次数的上限被限制了。\n放宽对速度过慢原因引起的上抬次数限制。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=284144",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#286039",
      "symptom": "挖机挖料时，偶现停顿10秒左右继续挖料",
      "category": "逻辑",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286039",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现1%】"
      ]
    },
    {
      "id": "#285481",
      "symptom": "第一铲挖料时，重复挖料，挖机卡住不动，挖掘点不停更新",
      "category": "规划层",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285481",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现10%】",
        "【卸料点异常】"
      ]
    },
    {
      "id": "#283852",
      "symptom": "挖机挖料时，不收斗，空挖，抬大臂空中收斗，无效装车",
      "category": "逻辑",
      "solution": "挖料逻辑bug，挖斗角度计算出错。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283852",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现10%】"
      ]
    },
    {
      "id": "#285870",
      "symptom": "装车过程中，多铲满斗率低（17、18、19、20铲），铲斗内收太过无法感知铲斗内料堆，不会重挖",
      "category": "控制层",
      "solution": "增加高程图积分体积判满阈值，改变挖斗内收角度。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285870",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#276380",
      "symptom": "左侧挖料装车，前部未满，尾部挺满",
      "category": "逻辑",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=276380",
      "tags": [
        "【v2.6真机环境】",
        "【沃尔沃】",
        "【车尾装车】"
      ]
    },
    {
      "id": "#286825",
      "symptom": "挖料完成后转向卡车时，转过头，卸料在卡车外面",
      "category": "规划层",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286825",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】",
        "【偶现50%】"
      ]
    },
    {
      "id": "#279773",
      "symptom": "挖料后旋转时，网络卡顿导致挖机超调，铲斗停顿10秒边开斗边旋转卸料时，斗齿碰到卡车侧挡板",
      "category": "规划层",
      "solution": "座舱超调导致卸料结束位置不在卡车内，回去时卡车碰撞角度检测出错。铲斗卸料完成后在卡车外，导致回来的离开卡车点计算出错。需要修改规划器，涉及较大的开发任务，待处理完其他优先级高的单子后再开发。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=279773",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】",
        "【安全】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#287227",
      "symptom": "网络波动影响装车，挖机转过头，网络恢复，卸料在卡车外面，转回挖掘区容易撞卡车",
      "category": "硬件",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287227",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#286035",
      "symptom": "挖机卸料时，铲齿碰卡车",
      "category": "规划层",
      "solution": "挖机和卡车的相对位姿触发了规划器的corner case，计算碰撞干涉点出错。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286035",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现40%】",
        "【挖机未拖动】"
      ]
    },
    {
      "id": "#283850",
      "symptom": "挖机挖料时勾到大石头，挖机翘屁股，倾覆危险",
      "category": "控制层",
      "solution": "1.增加挖机翘屁股的保护\n2.艺帆的imu的pitch角相反的单子必须先修复，否则顶起和翘屁股的逻辑会搞反，非常危险。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=283850",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现5%】"
      ]
    },
    {
      "id": "#285482",
      "symptom": "第2铲卸料时铲齿蹭卡车侧挡板",
      "category": "感知层",
      "solution": "回放bag包和高程图发现卡车位姿检测或者rtk偏了。小臂向前伸的距离也不够。待排查rtk问题。观察/gps_fix/truck发现分析RTK的角度发现没有阶跃角度，并且第二铲的开始卸料的角度明显比第一铲更右，最终卸料的位置比第一铲更左，和视频相符。综上，应该是疑似提前卸料和履带拖动导致的。拖动导致卡车位姿问题是主因，需要制定新的方案处理（如旋转过程中再检测卡车位姿等）。座舱先停止再微调导致卸料时位置有偏差问题轨迹，后续在线调整方案来解决",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285482",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【双车道右侧挖料装车】",
        "【偶现1%】"
      ]
    },
    {
      "id": "#285871",
      "symptom": "挖料未满，触发重挖，一直在一个地方重复挖料一直挖不满，铲数在加",
      "category": "逻辑",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=285871",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【重复挖料】"
      ]
    },
    {
      "id": "#287223",
      "symptom": "挖机卸料完成后，转向挖掘区，提前下大臂砸卡车",
      "category": "控制层",
      "solution": "无",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=287223",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#276302",
      "symptom": "卸料后开斗会撞油缸",
      "category": "规划层",
      "solution": "需要研发在线轨迹调整新算法，卸料翻斗速度过快。观察/force_controller/internal_joint_velocity_command/data[2]/joint_states/bucket/velocity发现液压延时太高，已经发减速命令了铲斗还在加速。修改为unload阶段也做碰撞保护。unload阶段铲斗速度过大以及延时问题，导致超调。限制unload阶段铲斗速度，以及增大安全保护时间",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=276302",
      "tags": [
        "【v2.6.1真机环境】",
        "【沃尔沃】",
        "【车尾装车】",
        "【偶现：20%】"
      ]
    },
    {
      "id": "#265312",
      "symptom": "卡车在左侧，卸料偏左，左侧撒料，车尾装太满撒料，车头位置装的相对较少",
      "category": "逻辑",
      "solution": "车头卸料需要伸入车厢，此版很难通过bug修复方式实现",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=265312",
      "tags": [
        "【v2.6】",
        "【真机环境】",
        "【自动装车】",
        "【效果】"
      ]
    },
    {
      "id": "#286534",
      "symptom": "重复挖掘检测时机不对，偶尔能检测到触发重复挖掘，大多数是检测不到",
      "category": "逻辑",
      "solution": "查看日志发现上抬时间太短而检测时间太长，检测完已经旋转了。已经修改成旋转过程也保留和使用检测结果",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=286534",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】"
      ]
    },
    {
      "id": "#284143",
      "symptom": "卸料时，边旋转边卸料，物料撒料",
      "category": "控制层",
      "solution": "调pid参数控制到位",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=284143",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现：5%】"
      ]
    },
    {
      "id": "#279260",
      "symptom": "挖料完成转向卡车时，出现超调现象，转过头在回调",
      "category": "规划层",
      "solution": "中途出现了往回的速度，需要研发轨迹在线调整新算法",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=279260",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】",
        "【偶现30%】"
      ]
    },
    {
      "id": "#279407",
      "symptom": "挖料上抬进入旋转时动作不连贯，存在卡顿现象",
      "category": "控制层",
      "solution": "观察了WARNf发现触发了碰撞紧急处理，目前算法只能降低座舱速度，抬到位后再重规划，等后续在线调整速度算法才能避免",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=279407",
      "tags": [
        "【2.6真机环境】",
        "【沃尔沃】"
      ]
    },
    {
      "id": "#282965",
      "symptom": "装车过程中出现，无法规划至卡车点，中断装车",
      "category": "感知层",
      "solution": "这个问题使用仿真的高程图也存在，去看WARN信息报错：卡车识别失败。目前图像数量较少，等积累一批badcase后统一优化模型",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=282965",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现:5%】",
        "【卸料点异常】"
      ]
    },
    {
      "id": "#281614",
      "symptom": "进入装车技能，激光频率掉到1，报子服务异常无法装车",
      "category": "感知层",
      "solution": "添加了点云去噪模块的耗时信息打印，可开启去噪开关再用日志定位下是否会导致点云去噪耗时增加。 日志记录在 livox_ros_driver-livox_lidar.launch.txt",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=281614",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现30%】",
        "【开启去噪】"
      ]
    },
    {
      "id": "#281642",
      "symptom": "第8、9铲挖掘点与蓝点挖掘点有偏差",
      "category": "规划层",
      "solution": "下大臂过快导致，地形较高导致座舱未运动到位，大臂先到达触地角度值。需要保证座舱小臂运动到位前大臂不能运动太低，需要新的轨迹调整算法实现。",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=281642",
      "tags": [
        "【2.6.1真机环境】",
        "【沃尔沃】",
        "【偶现10%】"
      ]
    },
    {
      "id": "#279402",
      "symptom": "自动装车时，手动或异常退出装车，结算页面多数数据为0",
      "category": "逻辑",
      "solution": "状态机上报的时多车的统计值，手动中断会把非正常装车过程的时间信息加入整体统计数据中，影响整体数据的统计，待后面产品制定特定的退出逻辑",
      "link": "https://fuxi.pm.netease.com/v6/issues?project_id=119&query_id=1600&issue_id=279402",
      "tags": [
        "【2.6.1真机环境】",
        "【中联】",
        "【unity客户端】"
      ]
    }
  ];

  const categoryMap = {
    'UI': 'badge-ui',
    '后端': 'badge-backend',
    '性能': 'badge-perf',
    '安全': 'badge-security',
    '兼容性': 'badge-compat'
  };

  const $list = document.getElementById('list');
  const $filter = document.getElementById('filter');
  const $tagFilter = document.getElementById('tag-filter');
  const $search = document.getElementById('search');
  const $counts = document.getElementById('counts');
  const $empty = document.getElementById('empty');
  const $reset = document.getElementById('reset');
  const $activeCats = document.getElementById('active-cats');
  const $activeTags = document.getElementById('active-tags');

  // 添加表单相关元素（位于模态）
  const $openAdd = document.getElementById('open-add');
  const $addModal = document.getElementById('add-modal');
  const $addId = document.getElementById('add-id');
  const $addSymptom = document.getElementById('add-symptom');
  const $addSolution = document.getElementById('add-solution');
  const $addLink = document.getElementById('add-link');
  const $addCategory = document.getElementById('add-category');
  const $addCustomCat = document.getElementById('add-custom-category');
  const $addSave = document.getElementById('add-save');
  const $addCancel = document.getElementById('add-cancel');
  const $addTagInput = document.getElementById('add-tag-input');
  const $addTagAdd = document.getElementById('add-tag-add');
  const $addTagList = document.getElementById('add-tag-list');

  // 尝试从后端加载数据，失败时回落到本地初始数据（并保持可离线使用）
  async function loadFromApi(){
    // 直接用前端变量渲染
    data = bugData;
    render(data);
  }

  function mergeUniqueById(arr){
    const map = new Map();
    arr.forEach(item=>{
      if(!item || !item.id) return;
      if(!map.has(item.id)) map.set(item.id, item);
    });
    return Array.from(map.values());
  }

  async function init(){
    await loadFromApi();
    populateFilter();
    populateTagFilter();
    populateAddCategory();
    bindEvents();
    render(data);
  }

  // 详情模态相关元素
  const $detailModal = document.getElementById('detail-modal');
  const $detailId = document.getElementById('detail-id');
  const $detailCategory = document.getElementById('detail-category');
  const $detailSymptom = document.getElementById('detail-symptom');
  const $detailSolution = document.getElementById('detail-solution');
  const $detailLink = document.getElementById('detail-link');
  const $detailClose = document.getElementById('detail-close');
  const $detailCancel = document.getElementById('detail-cancel');
  const $detailSave = document.getElementById('detail-save');
  const $detailDelete = document.getElementById('detail-delete');
  const $detailTagInput = document.getElementById('detail-tag-input');
  const $detailTagAdd = document.getElementById('detail-tag-add');
  const $detailTagList = document.getElementById('detail-tag-list');

  let currentDetailId = null;
  let addTags = [];
  let detailTags = [];
  let activeCats = [];
  let activeTags = [];

  function openDetail(id){
    const item = data.find(d=>d.id === id);
    if(!item) return;
    currentDetailId = id;
    $detailId.textContent = item.id;
    populateDetailCategoryOptions(item.category || '未分类');
    $detailSymptom.value = item.symptom || '';
    $detailSolution.value = item.solution || '';
    $detailLink.value = item.link || '';
    detailTags = Array.isArray(item.tags) ? [...item.tags] : [];
    renderTagPills($detailTagList, detailTags, (tag)=>removeDetailTag(tag));
    $detailModal.classList.remove('hidden');
    $detailModal.classList.add('flex');
    $detailSymptom.focus();
  }

  function closeDetail(){
    currentDetailId = null;
    $detailModal.classList.add('hidden');
    $detailModal.classList.remove('flex');
  }

  $detailClose.addEventListener('click', closeDetail);
  $detailCancel.addEventListener('click', closeDetail);

  $detailSave.addEventListener('click', async ()=>{
    if(!currentDetailId) return;
    const idx = data.findIndex(d=>d.id === currentDetailId);
    if(idx === -1) return;
    const newSymptom = $detailSymptom.value.trim();
    const newSolution = $detailSolution.value.trim();
    const newLink = $detailLink.value.trim();
    const newCategory = ($detailCategory.value || '未分类');
    try{
      const res = await fetch(API_BASE + '/' + encodeURIComponent(currentDetailId), {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ symptom: newSymptom, category: newCategory, solution: newSolution, link: newLink, tags: detailTags })
      });
      if(res.ok){
        const updated = await res.json();
        data[idx] = updated;
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
        applyFilter();
        populateTagFilter();
        closeDetail();
      } else {
        const j = await res.json().catch(()=>({})); alert('保存失败：' + (j.error||res.status));
      }
    }catch(e){
      alert('无法连接后端，更新将在本地保存（离线）');
      data[idx].symptom = newSymptom;
      data[idx].solution = newSolution;
      data[idx].link = newLink;
      data[idx].tags = [...detailTags];
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(err){}
      applyFilter();
      populateTagFilter();
      closeDetail();
    }
  });

  $detailDelete.addEventListener('click', async ()=>{
    if(!currentDetailId) return;
    if(!confirm('确定要删除此 Bug 吗？此操作不可恢复。')) return;
    const idx = data.findIndex(d=>d.id === currentDetailId);
    if(idx === -1) return;
    try{
      const res = await fetch(API_BASE + '/' + encodeURIComponent(currentDetailId), { method: 'DELETE' });
      if(res.status === 204){
        data.splice(idx, 1);
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
        applyFilter(); closeDetail();
      } else {
        const j = await res.json().catch(()=>({})); alert('删除失败：' + (j.error||res.status));
      }
    }catch(e){
      // 离线回退：在本地删除
      data.splice(idx, 1);
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(err){}
      applyFilter(); closeDetail();
    }
  });

  function populateFilter(){
    // 重建筛选项，保留第一个 "全部层面"
    $filter.innerHTML = '<option value="" disabled selected>全部层面</option>';
    const cats = Array.from(new Set(data.map(d=>d.category).filter(Boolean)));
    cats.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      $filter.appendChild(opt);
    });
    // 下拉自身不记录多选，仅用于一次选一个加入 activeCats
    $filter.value = '';
  }

  function populateTagFilter(){
    $tagFilter.innerHTML = '<option value="" disabled selected>Tag</option>';
    const tagSet = new Set();
    data.forEach(d=>{
      if(Array.isArray(d.tags)){
        d.tags.forEach(t=>{
          if(t) tagSet.add(t);
        });
      }
    });
    Array.from(tagSet).sort().forEach(t=>{
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      $tagFilter.appendChild(opt);
    });
    $tagFilter.selectedIndex = 0;
  }

  function populateAddCategory(){
    $addCategory.innerHTML = '<option value="">未分类</option>';
    const cats = Array.from(new Set(data.map(d=>d.category).filter(Boolean)));
    cats.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      $addCategory.appendChild(opt);
    });
    const customOpt = document.createElement('option');
    customOpt.value = 'custom';
    customOpt.textContent = '自定义分类';
    $addCategory.appendChild(customOpt);
  }

  function bindEvents(){
    // 单击即可多选：选中即加入/移除，列表重新过滤
    $filter.addEventListener('change', ()=>{
      const val = $filter.value;
      if(!val) return;
      if(activeCats.includes(val)){
        activeCats = activeCats.filter(c=>c !== val);
      }else{
        activeCats.push(val);
      }
      renderActiveFilters();
      applyFilter();
      // 重置回占位，便于再次点击同一选项也触发 change
      $filter.selectedIndex = 0;
    });

    $tagFilter.addEventListener('change', ()=>{
      const val = $tagFilter.value;
      if(!val) return;
      if(activeTags.includes(val)){
        activeTags = activeTags.filter(t=>t !== val);
      }else{
        activeTags.push(val);
      }
      renderActiveFilters();
      applyFilter();
      $tagFilter.selectedIndex = 0;
    });
    $search.addEventListener('input', debounce(applyFilter, 180));
    $reset.addEventListener('click', ()=>{
      $filter.value = '';
      $tagFilter.value = '';
      activeCats = [];
      activeTags = [];
      renderActiveFilters();
      $search.value = '';
      applyFilter();
    });

    $addCategory.addEventListener('change', ()=>{
      if($addCategory.value === 'custom'){
        $addCustomCat.classList.remove('hidden');
        $addCustomCat.focus();
      }else{
        $addCustomCat.classList.add('hidden');
      }
    });

    // 打开添加模态
    $openAdd.addEventListener('click', ()=>{
      $addModal.classList.remove('hidden');
      $addModal.classList.add('flex');
      // refresh category list
      populateAddCategory();
      resetAddTags();
      $addId.focus();
    });
    $addCancel.addEventListener('click', ()=>{
      $addModal.classList.add('hidden');
      $addModal.classList.remove('flex');
    });
    $addSave.addEventListener('click', ()=>{
      handleAdd();
    });

    $addTagAdd.addEventListener('click', ()=>{
      addTagFromInput();
    });
    $addTagInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        addTagFromInput();
      }
    });

    $detailTagAdd.addEventListener('click', ()=>{
      addDetailTagFromInput();
    });
    $detailTagInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        addDetailTagFromInput();
      }
    });

    // no-op
  }

  async function handleAdd(){
    let id = $addId.value.trim();
    const symptom = $addSymptom.value.trim();
    if(!symptom){
      alert('请填写现象（必填）');
      $addSymptom.focus();
      return;
    }
    const solution = ($addSolution && $addSolution.value) ? $addSolution.value.trim() : '';
    let category = $addCategory.value === 'custom' ? $addCustomCat.value.trim() : $addCategory.value;
    category = category || '未分类';

    // 请求后端新增（后端会生成 ID 如果未提供）
    try{
      const body = { id: id || undefined, symptom, category, solution, tags: addTags };
      if($addLink){ body.link = $addLink.value.trim(); }
      const res = await fetch(API_BASE, {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      if(res.status === 201){
        const created = await res.json();
        data.unshift(created);
        // 本地缓存一份以支持离线
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
        populateFilter();
        populateTagFilter();
        populateAddCategory();
        applyFilter();
        // 清理表单并关闭模态
        $addId.value = '';
        $addSymptom.value = '';
        if($addSolution) $addSolution.value = '';
        if($addLink) $addLink.value = '';
        $addCategory.value = '';
        $addCustomCat.value = '';
        $addCustomCat.classList.add('hidden');
        resetAddTags();
        $addSymptom.focus();
        $addModal.classList.add('hidden'); $addModal.classList.remove('flex');
      } else if(res.status === 409){
        const j = await res.json(); alert('新增失败：' + (j.error || '冲突')); $addId.focus();
      } else {
        const j = await res.json().catch(()=>({})); alert('新增失败'); console.warn('add failed', j);
      }
    }catch(e){
      alert('无法连接到后端，新增将保存在本地（离线模式）');
      // 离线回退：在本地生成 ID 并保存到 localStorage
      if(!id){ const nums = data.map(d=>{ const m = (d.id||'').match(/(\d+)$/); return m ? parseInt(m[1],10) : 0; }); const max = nums.length ? Math.max(...nums) : 0; id = 'BUG-' + String(max + 1).padStart(3, '0'); }
      if(data.find(d=>d.id===id)){ alert('ID 已存在，请使用其它 ID'); $addId.focus(); return; }
      const item = { id, symptom, category, solution, tags: [...addTags] };
      if($addLink) item.link = $addLink.value.trim();
      data.unshift(item);
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(err){}
      populateFilter();
      populateAddCategory();
      populateTagFilter();
      applyFilter();
      $addId.value='';
      $addSymptom.value='';
      if($addSolution) $addSolution.value='';
      if($addLink) $addLink.value='';
      $addCategory.value='';
      $addCustomCat.value='';
      $addCustomCat.classList.add('hidden');
      resetAddTags();
      $addSymptom.focus();
      $addModal.classList.add('hidden'); $addModal.classList.remove('flex');
    }
  }

  function applyFilter(){
    const q = $search.value.trim().toLowerCase();
    let filtered = data.filter(item=>{
      // 分类采用并集：只要有一个 activeCats 命中即可
      const matchesCat = activeCats.length
        ? activeCats.some(cat => cat === item.category)
        : true;
      const tagsArr = Array.isArray(item.tags) ? item.tags : [];
      // Tag 仍为交集
      const matchesTag = activeTags.length
        ? activeTags.every(t => tagsArr.includes(t))
        : true;
      const matchesQ = q ? (item.id.toLowerCase().includes(q) || item.symptom.toLowerCase().includes(q)) : true;
      return matchesCat && matchesTag && matchesQ;
    });
    render(filtered);
  }

  function render(list){
    $list.innerHTML = '';
    if(list.length === 0){
      $empty.classList.remove('hidden');
      $counts.textContent = '';
      document.getElementById('pagination')?.remove();
      renderPieChart([]);
      return;
    }
    $empty.classList.add('hidden');

    // 分页参数
    const pageSize = 9;
    window._currentPage = window._currentPage || 1;
    const totalPage = Math.ceil(list.length / pageSize);
    if(window._currentPage > totalPage) window._currentPage = totalPage || 1;
    const startIdx = (window._currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageList = list.slice(startIdx, endIdx);

    $counts.textContent = `${list.length} 个结果，${window._currentPage}/${totalPage||1}页`;

    pageList.forEach(item=>{
      const safeId = escapeHtml(item.id || '');
      const safeSymptom = escapeHtml((item.symptom || '').trim() || '无描述');
      const catClass = categoryMap[item.category] || 'bg-gray-200';
      const catLabel = escapeHtml(item.category || '未分类');
      const tagsArr = Array.isArray(item.tags) ? item.tags : [];
      const el = document.createElement('div');
      el.className = 'bg-white rounded-xl p-5 shadow-sm card-hover fade-in cursor-pointer';
      el.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold mt-1">${safeId}</div>
          </div>
          <div class="text-right">
            <div class="inline-block px-3 py-1 rounded-full text-xs font-medium ${catClass}">${catLabel}</div>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-700">${safeSymptom}</div>
        ${tagsArr.length ? `
        <div class="mt-3 flex flex-wrap gap-2">
          ${tagsArr.map(t => `<span class="px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 text-xs">${escapeHtml(t)}</span>`).join('')}
        </div>` : ''}
      `;

      // 打开详情（点击卡片）
      el.addEventListener('click', ()=>openDetail(item.id));

      $list.appendChild(el);
    });

    // 分页控件
    document.getElementById('pagination')?.remove();
    const pag = document.createElement('div');
    pag.id = 'pagination';
    pag.className = 'flex justify-center items-center gap-2 mt-8';
    if(totalPage > 1){
      const prev = document.createElement('button');
      prev.textContent = '上一页';
      prev.className = 'px-3 py-1 rounded bg-gray-200 hover:bg-gray-300';
      prev.disabled = window._currentPage === 1;
      prev.onclick = ()=>{
        window._currentPage--;
        render(list);
        pag.scrollIntoView({behavior:'smooth'});
      };
      pag.appendChild(prev);

      for(let i=1;i<=totalPage;i++){
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'px-2 py-1 rounded ' + (i===window._currentPage?'bg-indigo-600 text-white':'bg-gray-100 hover:bg-gray-200');
        btn.onclick = ()=>{
          window._currentPage = i;
          render(list);
          pag.scrollIntoView({behavior:'smooth'});
        };
        pag.appendChild(btn);
      }

      const next = document.createElement('button');
      next.textContent = '下一页';
      next.className = 'px-3 py-1 rounded bg-gray-200 hover:bg-gray-300';
      next.disabled = window._currentPage === totalPage;
      next.onclick = ()=>{
        window._currentPage++;
        render(list);
        pag.scrollIntoView({behavior:'smooth'});
      };
      pag.appendChild(next);
    }
    // 插入到bug列表上方（饼状图上方）
    $list.parentNode.insertBefore(pag, document.getElementById('pie-chart-container'));

    // 渲染饼状图（用全部数据，不分页）
    renderPieChart(list);
  }

  function debounce(fn, wait){
    let t;
    return function(...args){
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this,args), wait);
    }
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  init();

  // tag 处理相关工具函数
  function renderTagPills(container, tags, onRemove){
    if(!container) return;
    container.innerHTML = '';
    if(!tags || !tags.length){
      container.classList.add('hidden');
      return;
    }
    container.classList.remove('hidden');
    tags.forEach(tag=>{
      const pill = document.createElement('span');
      pill.className = 'px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 text-xs flex items-center gap-1';
      pill.innerHTML = `<span>${escapeHtml(tag)}</span><button type="button" class="text-indigo-500 hover:text-indigo-700 text-xs">×</button>`;
      const btn = pill.querySelector('button');
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        onRemove(tag);
      });
      container.appendChild(pill);
    });
  }

  function resetAddTags(){
    addTags = [];
    if($addTagInput) $addTagInput.value = '';
    renderTagPills($addTagList, addTags, (tag)=>removeAddTag(tag));
  }

  function addTagFromInput(){
    if(!$addTagInput) return;
    const val = $addTagInput.value.trim();
    if(!val) return;
    if(!addTags.includes(val)){
      addTags.push(val);
      renderTagPills($addTagList, addTags, (tag)=>removeAddTag(tag));
    }
    $addTagInput.value = '';
    $addTagInput.focus();
  }

  function removeAddTag(tag){
    addTags = addTags.filter(t=>t !== tag);
    renderTagPills($addTagList, addTags, (t)=>removeAddTag(t));
  }

  function addDetailTagFromInput(){
    if(!$detailTagInput) return;
    const val = $detailTagInput.value.trim();
    if(!val) return;
    if(!detailTags.includes(val)){
      detailTags.push(val);
      renderTagPills($detailTagList, detailTags, (tag)=>removeDetailTag(tag));
    }
    $detailTagInput.value = '';
    $detailTagInput.focus();
  }

  function removeDetailTag(tag){
    detailTags = detailTags.filter(t=>t !== tag);
    renderTagPills($detailTagList, detailTags, (t)=>removeDetailTag(t));
  }

  function populateDetailCategoryOptions(selected){
    if(!$detailCategory) return;
    const cats = Array.from(new Set(data.map(d=>d.category).filter(Boolean)));
    $detailCategory.innerHTML = '<option value="">未分类</option>';
    cats.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      $detailCategory.appendChild(opt);
    });
    $detailCategory.value = selected || '';
  }

  function renderActiveFilters(){
    if($activeCats){
      $activeCats.innerHTML = '';
      activeCats.forEach(cat=>{
        const pill = document.createElement('span');
        pill.className = 'px-2 py-1 rounded-full bg-slate-100 text-slate-700 flex items-center gap-1';
        pill.innerHTML = `<span>层面: ${escapeHtml(cat)}</span><button type="button" class="text-slate-400 hover:text-slate-700 text-xs">×</button>`;
        pill.querySelector('button').addEventListener('click', (e)=>{
          e.stopPropagation();
          activeCats = activeCats.filter(c=>c !== cat);
          renderActiveFilters();
          applyFilter();
        });
        $activeCats.appendChild(pill);
      });
    }
    if($activeTags){
      $activeTags.innerHTML = '';
      activeTags.forEach(tag=>{
        const pill = document.createElement('span');
        pill.className = 'px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 flex items-center gap-1';
        pill.innerHTML = `<span>Tag: ${escapeHtml(tag)}</span><button type="button" class="text-indigo-300 hover:text-indigo-700 text-xs">×</button>`;
        pill.querySelector('button').addEventListener('click', (e)=>{
          e.stopPropagation();
          activeTags = activeTags.filter(t=>t !== tag);
          renderActiveFilters();
          applyFilter();
        });
        $activeTags.appendChild(pill);
      });
    }
  }
  </script>
</body>
</html>
